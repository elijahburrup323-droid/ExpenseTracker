<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="mb-6">
    <div class="flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400 mb-2">
      <%= link_to "Documentation", documentation_path, class: "hover:text-brand-600 dark:hover:text-brand-400 transition" %>
      <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
      <span class="text-gray-900 dark:text-white font-medium">Claude.ai Prompt</span>
    </div>
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Claude.ai Prompt</h1>
    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Copy this prompt into a new Claude.ai session to get it up to speed on the BudgetHQ project</p>
  </div>

  <%# Copy button %>
  <div class="mb-4 flex justify-end">
    <button type="button" id="copyPromptBtn"
            class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-brand-600 hover:bg-brand-700 rounded-lg shadow-sm transition"
            onclick="navigator.clipboard.writeText(document.getElementById('promptContent').innerText).then(() => { this.innerHTML = '<svg class=\'h-4 w-4 mr-1.5\' fill=\'none\' viewBox=\'0 0 24 24\' stroke=\'currentColor\' stroke-width=\'2\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' d=\'M5 13l4 4L19 7\'/></svg>Copied!'; setTimeout(() => { this.innerHTML = '<svg class=\'h-4 w-4 mr-1.5\' fill=\'none\' viewBox=\'0 0 24 24\' stroke=\'currentColor\' stroke-width=\'2\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' d=\'M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3\'/></svg>Copy Prompt'; }, 2000) })">
      <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
      Copy Prompt
    </button>
  </div>

  <div id="promptContent" class="bg-white dark:bg-gray-800 rounded-lg shadow-sm ring-1 ring-gray-200 dark:ring-gray-700 p-6 text-sm font-mono text-gray-800 dark:text-gray-200 whitespace-pre-wrap leading-relaxed">You are helping me build BudgetHQ, a personal finance / budget tracking web application. Here is everything you need to know about the project.

## Tech Stack
- Ruby 3.2, Rails 7.1
- PostgreSQL database
- Devise authentication (email/password, OmniAuth: Google, Apple, Microsoft, phone SMS via Twilio)
- Hotwired: Turbo + Stimulus.js for frontend interactivity
- Tailwind CSS via CDN (with custom brand purple color palette and dark mode)
- Importmap for JavaScript module loading (no webpack/esbuild)
- Deployed on Render.com at https://djburrup.com/expensetracker (relative_url_root = "/expensetracker")

## Project Location
- Local path: C:/Projects/ExpenseTracker
- GitHub: https://github.com/elijahburrup323-droid/ExpenseTracker (main branch)
- Windows development environment (MINGW64)

## Architecture Overview
The app uses a sidebar navigation layout. All CRUD screens are single-page with Stimulus controllers that call JSON API endpoints. There are NO Turbo Frames or Turbo Streams used for data — all data operations go through fetch() calls to /api/* endpoints.

### Layout Structure
- Collapsible left sidebar (w-56 expanded, w-16 collapsed) with gradient purple background
- Sidebar groups: Accounts (Account Types), Deposits (Frequencies, Recurring Deposits), Payments (Categories, Spending Types), Admin (DBU, Users, Documentation, Frequency Masters — admin only, always at bottom). Sub-menus sorted alphabetically within each group.
- Circular collapse/expand button on right edge of sidebar (absolute positioned, -right-3)
- Bottom sidebar section: user profile button (name + avatar) — click to expand/collapse dropdown with Theme toggle, Settings link, Sign Out link
- Top header bar showing "Hello {first name}", motivational quote, current date, and profile dropdown (upper-right corner with avatar, contains Toggle Theme, Settings, Sign Out — always visible, sticky z-30)
- Stacked sticky headers: On the Payments page, the page toolbar (h1 + Add Payment button) is sticky top-14 z-20 with shadow-sm, stacking below the Hello bar (sticky top-0 z-30) so both remain visible while scrolling
- Responsive filter grid: Payments filters use md:grid-cols-3 (tablet/iPad) and lg:grid-cols-6 (desktop). Date inputs min-width 150px, Account/Category dropdowns min-width 160px, Spending Type min-width 120px / max-width 180px with text truncation. Search row spans columns so Search button aligns under Reset on tablet.
- Main content area shifts with sidebar via margin
- Sidebar state + group collapse state persisted in localStorage
- Dark/light theme toggle persisted in localStorage
- Global footer on all screens: Contact · Help · Terms · Privacy · © BudgetHQ {year} — centered, single-line, gray text, sticks to bottom via flex layout

### Pattern: Every CRUD Screen Follows This Architecture
1. **HTML page controller** (e.g., AccountsController#index) — renders the HTML shell with a Stimulus data-controller div
2. **API controller** (e.g., Api::AccountsController) — JSON CRUD endpoints (index, create, update, destroy)
3. **Stimulus controller** (e.g., accounts_controller.js) — fetches data on connect(), renders table rows as innerHTML, manages add/edit/delete state machine (idle → adding → editing)
4. **Inline editing** — edit row replaces display row, Enter saves, Escape cancels. Payments uses a modal for Add (all other screens use inline add row).
5. **Soft delete** — all models use deleted_at timestamp, default_scope excludes deleted records

## Admin Role
- **budgethq_agent** boolean on users table (default false). Only DJ and Elijah have this flag.
- Admin users see an "Admin" group in the sidebar containing: DBU, Users, Documentation, and Frequency Masters.
- Admin users also see Generate Data buttons on all CRUD screens.
- Non-admins see the normal user experience without admin tools.
- Admin user management screen (/admin/users, titled "Admin Users") lets admins search users and toggle admin status via API.

## Database Tables

### Core User Data
- **users** — Devise fields + first_name, last_name, avatar_url, phone_number, secondary_email, budgethq_agent, two_factor_enabled, subscription_active, subscription_start_date, subscription_expiration_date
- **identities** — OmniAuth provider linkage (provider, uid, tokens)
- **user_emails** — Alternate email addresses with verification (user_id, email, verification_code, verified_at)
- **user_phones** — Alternate phone numbers with SMS verification (user_id, phone_number, verification_code, verified_at)
- **phone_verifications** — SMS verification codes

### Spending Side
- **spending_types** — user-scoped categories of spending (Need, Want, Savings — seeded as system defaults)
- **spending_categories** — user-scoped, belongs_to spending_type (Groceries, Dining, Mortgage — seeded)
- **account_types** — user-scoped (Checking, Savings, Venmo — seeded as system defaults)
- **accounts** — user-scoped, belongs_to account_type (balance, beginning_balance, include_in_budget flag)
- **payments** — user-scoped, belongs_to account + spending_category, optional spending_type_override. Payment create/update/destroy adjusts account balance in a transaction.

### Income Side
- **income_frequency_masters** — global lookup table with 59 frequency patterns across 3 types: standard (11), exact_day (29: 1st-28th + Last Day), ordinal_weekday (20: 1st-4th Mon-Fri). Pre-seeded. Agent-editable via Frequency Masters screen.
- **income_user_frequencies** — user-scoped join to frequency_masters with use_flag toggle
- **income_recurrings** — user-scoped recurring income sources (name, amount, frequency, next_date, use_flag). Has advance_next_date! to calculate next occurrence.
- **income_entries** — user-scoped income transactions. Auto-generated from due recurrings via IncomeEntry.generate_due_entries_for(user). Has received_flag toggle. When received_flag is toggled ON, account balance is adjusted (same transactional pattern as payments). Income entries with received_flag=true for budget accounts are summed into Dashboard Card 4 as "Income".

### Admin / System Tables
- **bug_reports** — screen_name, description, processed_date. Displayed on Documentation &gt; Release Notes, paginated by date (5 days per page).
- **legal_pages** — slug (unique), title, content (HTML), published_at. Stores Privacy Policy, Terms of Service, etc. Accessible at /pages/:slug. Seeded via db/seeds/legal_pages.rb.
- **net_worth_snapshots** — user_id (FK), snapshot_date (date, unique per user), amount (decimal 12,2). Stores monthly net worth history for the dashboard chart. Shows up to 6 months. Admin can populate test data via POST /api/net_worth_snapshots/populate.

### Key Relationships
- User has_many: spending_types, spending_categories, account_types, accounts, payments, income_user_frequencies, income_recurrings, income_entries
- SpendingType has_many spending_categories; SpendingCategory has_many payments
- AccountType has_many accounts; Account has_many payments
- IncomeRecurring has_many income_entries; both link to frequency_master and optional account
- All user-owned models use soft delete (deleted_at) with default_scope

## Routes Structure
```
/ ...................... Landing page (redirects to dashboard if signed in)
/dashboard ............. Dashboard with 6 cards (budget, accounts, net worth, income/spending, recent activity, buckets)
/accounts .............. Accounts CRUD screen
/account_types ......... Account Types CRUD screen
/spending_types ........ Spending Types CRUD screen
/spending_categories ... Categories CRUD screen
/payments .............. Payments CRUD screen (with advanced filtering & combination search)
/income_entries ........ Deposits CRUD screen (with Generate Data button)
/income_recurrings ..... Recurring Deposits CRUD screen
/income_user_frequencies Frequencies toggle screen
/income_frequency_masters Frequency Masters CRUD (admin-only)
/admin/users ............. Admin user management (admin-only)
/dbu .................. Database Utility admin tool (admin-only)
/documentation ......... Documentation index (admin-only sidebar link)
/documentation/database-schema
/documentation/database-visualization
/documentation/release-notes
/documentation/claude-prompt
/documentation/architecture-overview
/documentation/deployment-runbook
/documentation/test-coverage
/documentation/environment-variables
/pages/:slug ........... Legal pages (privacy, terms) — no auth required

API endpoints (all under /api/):
  /api/spending_types ......... CRUD
  /api/spending_categories .... CRUD
  /api/account_types .......... CRUD
  /api/accounts ............... CRUD
  /api/payments ............... CRUD (with transactional balance updates)
  /api/income_frequency_masters  CRUD (admin-only)
  /api/income_user_frequencies  index + update (use_flag toggle per frequency)
  /api/income_recurrings ...... CRUD
  /api/income_entries ......... CRUD + POST /generate (with transactional balance updates on received_flag)
  /api/admin/users ........... index + update (admin toggle, admin-only)
  /api/dbu/schema ............ DBU schema inspector — queries information_schema for all tables/columns/keys (admin-only)
  /api/dbu/tables ............ DBU table catalog for record browser (admin-only)
  /api/dbu/users ............. DBU user list (admin-only)
  /api/dbu/records ........... DBU record list/show/update/delete (admin-only)
  /api/dashboard/card_data ... GET with month/year params — returns spending, income/spending, and recent activity data for Cards 1, 4, 5
  /api/bug_reports ........... index (paginated by date) + create
  /api/net_worth_snapshots ... index (recent 6) + POST /populate (admin-only, generates test history)
```

## Stimulus Controllers
Each CRUD screen has a matching Stimulus controller in app/javascript/controllers/:
- **sidebar_controller.js** — collapse/expand sidebar, group toggles, tooltips, flyout menus, mobile hamburger
- **flash_controller.js** — auto-dismiss flash messages after 5s
- **dropdown_controller.js** — simple toggle + outside-click close
- **theme_controller.js** — dark/light mode toggle
- **otp_controller.js** — 6-digit OTP input with auto-submit
- **spending_types_controller.js** — CRUD with icon/color picker, generate dummy data
- **spending_categories_controller.js** — CRUD with type select, debt toggle
- **account_types_controller.js** — CRUD with icon/color picker, generate dummy data
- **accounts_controller.js** — CRUD with type select, budget toggle, generate dummy data
- **payments_controller.js** — CRUD with date/account/category/type filters, search, combination sum search, CSV export of filtered/sorted data, generate dummy data
- **income_frequency_masters_controller.js** — CRUD with inline editing, active toggle, sort_order editing (admin-only)
- **income_user_frequencies_controller.js** — use_flag toggle list with "View All" filter toggle (OFF = show only enabled frequencies, ON = show all master frequencies; purely a view filter, no bulk API call)
- **income_recurrings_controller.js** — CRUD with frequency/account selects, generate dummy data
- **income_entries_controller.js** — CRUD with received toggle (opens edit on amount), auto-advance cursor between fields on change, Generate Data button
- **admin_users_controller.js** — Admin user management with search, admin toggle (admin-only)
- **quotes_controller.js** — Rotating motivational budget quotes in header bar (100 quotes, cycles on page load, always visible)
- **bug_reports_controller.js** — Paginated release notes grouped by date with "Show More" pagination (5 days per page)
- **settings_emails_controller.js** — Alternate emails management: fetch, render with verified/unverified badges, inline 6-digit code verify, resend, remove with confirm
- **settings_phones_controller.js** — Alternate phones management: fetch, render with verified/unverified badges, inline 6-digit SMS code verify, resend, remove with confirm (parallel implementation to emails)
- **dashboard_controller.js** — Month navigation for dashboard Cards 1, 4, 5: shared month/year state, prev/next arrows, fetches data from /api/dashboard/card_data, re-renders card content dynamically, right arrow disabled at current month
- **dbu_controller.js** — Database Utility with two tabs: (1) Schema Inspector — queries information_schema to list ALL tables and ALL columns with data type, nullability, default, PK/FK/UQ badges, expand/collapse per table, filter by table/column name, Expand All/Collapse All, Refresh DBU, Export CSV/JSON, Last Refreshed timestamp and database name; (2) Record Browser — browse/edit records via dbu_table_catalogs, search, user filter, record navigation (Prev/Next), dirty state protection, save/delete. Admin-only.

## Seeding & Initialization
- db/seeds.rb creates test user (test@example.com / password123) and 40+ IncomeFrequencyMaster records
- On first visit, each screen auto-seeds defaults per user (spending types, categories, account types, frequencies)
- Must visit /spending_types before /spending_categories for new users (seeding dependency)

## Key Patterns & Conventions
1. **Soft delete everywhere** — model.soft_delete!, default_scope { where(deleted_at: nil) }
2. **User-scoped queries** — always current_user.model.find/build/create
3. **Transactional balance** — payments and received income entries adjust account.balance atomically
4. **State machine UI** — Stimulus controllers track state: idle/adding/editing
5. **Generate Data buttons** — most screens have a button to create dummy data for testing
6. **Sort order** — auto-assigned as max(sort_order)+1 on create
7. **Case-insensitive uniqueness** — name fields use lower() index with deleted_at IS NULL filter
8. **API error format** — { errors: ["message"] } with 422 status
9. **Admin gating** — Admin sidebar group (DBU, Users, Documentation, Frequency Masters), Generate Data buttons, and admin API endpoints are only visible/accessible to users with budgethq_agent=true
10. **Motivational quotes** — Header displays rotating budget quotes from a pool of 100, cycling on each page load (always visible, no toggle)
11. **Auto-cancel editing** — Clicking Add/Edit/Delete while another row is being edited auto-cancels the previous edit (no need for explicit cancel)
12. **Auto-save toggles** — All toggle switches (budget, use_flag, active, admin) save immediately via API without requiring a Save button
13. **Auto-advance cursor** — Deposits fields auto-advance focus to the next field in sequence (date → account → source → description → amount → frequency) on change. Payments add-row also auto-advances: Date → Account → Category → (auto-populate Spending Type) → Description
14. **Dashboard cards with month navigation** — Cards 1 (Spending Overview), 4 (Income &amp; Spending), and 5 (Recent Activity) all display month/year with left/right arrows for month navigation. All three cards share the same month state via a `dashboard` Stimulus controller that fetches data from `GET /api/dashboard/card_data?month=N&amp;year=YYYY`. Right arrow is disabled when at the current real-world month. Card 1 shows "$X spent this month" donut (no "Month To Date" text). Card 2 (Accounts) shows "Total: {sum}" in the header. Card 3 (Net Worth) chart runs chronologically LEFT → RIGHT (oldest on left, newest on right) with real data-driven SVG line chart from net_worth_snapshots table. Admins see "Populate Test Data" dropdown on Card 3.
15. **Delete guards** — Accounts, spending categories, and spending types cannot be deleted if they have dependent records (payments or child categories). The API returns a 422 error with a descriptive message.
16. **Resilient payment loading** — The payments index API preloads associations using unscoped queries, so payments with soft-deleted accounts/categories/types still render (showing "[Deleted]" labels) instead of crashing the entire endpoint.
17. **Dashboard Recent Activity filter** — Card 5 (Recent Activity) excludes payments with future dates (payment_date > today) so scheduled payments don't appear prematurely.
18. **Deposits rename** — "Income Entries" renamed to "Deposits" and "Recurring Income" to "Recurring Deposits" across sidebar, page headers, buttons, info text, and documentation.
19. **Deposits deleted account display** — Deposits API preloads accounts with unscoped queries so deleted account names still display (read-only) instead of blank.
20. **Deposits column sorting** — Date, Account, Source, Description, and Amount columns are click-to-sort with ASC/DESC toggle and arrow indicators.
21. **Settings page parity** — Email and Phone settings sections have identical structure: editable primary field (email_field / telephone_field), border-separated alternate section with Stimulus-managed add/verify/remove, and verified/unverified badges. Primary phone changes do not require current password. Two-Factor toggle is disabled with red warning message when no verified phone exists (primary or alternate).

## Development Notes
- Windows filesystem is case-insensitive but Rails can fail template lookups if path case doesn't match. Always start server from C:/Projects/ExpenseTracker (correct case).
- Tailwind is loaded via CDN with JIT — classes must exist in HTML for generation. Dynamic class toggling via JS uses classList.add/remove (not string interpolation).
- With Turbo loaded, forms submit via fetch(). Use Promise.all([page.waitForURL(...), page.click(...)]) for Turbo navigation waits in tests.
- Flash messages are positioned fixed top-right and auto-dismiss after 5s.
- **.gdoc file reading** — Google Drive for Desktop .gdoc files are cloud shortcuts that cannot be read via standard file I/O. Use `read_gdoc.py` (Python script in project root) which looks up the doc ID from DriveFS's metadata_sqlite_db and fetches content via Google Docs API with OAuth. Requires one-time setup: gdoc_credentials.json from Google Cloud Console. .docx files are read via Node.js JSZip (extract word/document.xml, strip XML tags).

## Task Intake: "Lets Work" Workflow

All work items are managed via Google Drive at **G:\My Drive\ExpenseTracker** using a Kanban-style folder flow:

### Folder Structure
- **Open Items** — bugs (text files) and new features (subfolders) waiting to be worked
- **In Process** — the single item currently being worked on
- **Ready for QA** — completed items awaiting user verification

### When I say "Lets Work"
1. Navigate to **G:\My Drive\ExpenseTracker\Open Items**
2. Pick one item (text file or feature folder) to work on
3. **Move** it from Open Items → **In Process**
4. **Plan** the implementation
5. **Build** the changes
6. **Test locally** with Playwright against both **Safari** and **Chrome** browsers
7. **Deploy** to production (commit to GitHub, trigger Render deploy)
8. **Test production** at https://djburrup.com/expensetracker with both accounts:
   - elijahburrup323@gmail.com / Eli624462!
   - djburrup@gmail.com / luckydjb
9. Once all production tests pass, **move** from In Process → **Ready for QA**
10. Go back to **Open Items** and grab the next item — repeat

### Bug text files
- Process items that have **no status**, or are marked **NOT FIXED**, **FAILED**, or similar
- **Skip** items marked **PASSED**, **FIXED**, or similar — they are already done

### General rules
- Work items one at a time (one item in "In Process" at a time)
- Deploy automatically when changes are ready and tested
- Commit to GitHub and trigger Render deploys as needed

## Behavior Rules
- **Never ask for acknowledgement or confirmation to continue.** Just do the work. Do not pause to say "shall I proceed?" or "ready to continue?" — execute each step and move to the next automatically.
- Do not ask "does this look good?" mid-task. Complete the full workflow, then present results.

## Pre-Commit Checklist
Before each git commit, update these three items:
1. app/views/documentation/database_schema.html.erb — reflect any schema changes
2. app/views/documentation/claude_prompt.html.erb — reflect any architectural/feature changes
3. Release Notes (bug_reports table) — add entries for features built and bugs fixed, with today's date as processed_date</div>
</div>
