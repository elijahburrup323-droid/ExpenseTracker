<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="mb-6">
    <div class="flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400 mb-2">
      <%= link_to "Documentation", documentation_path, class: "hover:text-brand-600 dark:hover:text-brand-400 transition" %>
      <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
      <span class="text-gray-900 dark:text-white font-medium">Claude.ai Prompt</span>
    </div>
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Claude.ai Prompt</h1>
    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Copy this prompt into a new Claude.ai session to get it up to speed on the BudgetHQ project</p>
  </div>

  <%# Copy button %>
  <div class="mb-4 flex justify-end">
    <button type="button" id="copyPromptBtn"
            class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-brand-600 hover:bg-brand-700 rounded-lg shadow-sm transition"
            onclick="navigator.clipboard.writeText(document.getElementById('promptContent').innerText).then(() => { this.innerHTML = '<svg class=\'h-4 w-4 mr-1.5\' fill=\'none\' viewBox=\'0 0 24 24\' stroke=\'currentColor\' stroke-width=\'2\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' d=\'M5 13l4 4L19 7\'/></svg>Copied!'; setTimeout(() => { this.innerHTML = '<svg class=\'h-4 w-4 mr-1.5\' fill=\'none\' viewBox=\'0 0 24 24\' stroke=\'currentColor\' stroke-width=\'2\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' d=\'M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3\'/></svg>Copy Prompt'; }, 2000) })">
      <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
      Copy Prompt
    </button>
  </div>

  <div id="promptContent" class="bg-white dark:bg-gray-800 rounded-lg shadow-sm ring-1 ring-gray-200 dark:ring-gray-700 p-6 text-sm font-mono text-gray-800 dark:text-gray-200 whitespace-pre-wrap leading-relaxed">You are helping me build BudgetHQ, a personal finance / budget tracking web application. Here is everything you need to know about the project.

## Tech Stack
- Ruby 3.2, Rails 7.1
- PostgreSQL database
- Devise authentication (email/password, OmniAuth: Google, Apple, Microsoft, phone SMS via Twilio)
- Hotwired: Turbo + Stimulus.js for frontend interactivity
- Tailwind CSS via CDN (with custom brand purple color palette and dark mode)
- Importmap for JavaScript module loading (no webpack/esbuild)
- Deployed on Render.com at https://djburrup.com/expensetracker (relative_url_root = "/expensetracker")
- Email delivery via SendGrid Web API (sendgrid-ruby gem) — Render blocks outbound SMTP ports, so we use the HTTP API instead of SMTP. API key stored in SENDGRID_PASSWORD env var.
- SMS delivery via Twilio REST API (twilio-ruby gem) — phone number auto-normalized to E.164 format

## Project Location
- Local path: C:/Projects/ExpenseTracker
- GitHub: https://github.com/elijahburrup323-droid/ExpenseTracker (main branch)
- Windows development environment (MINGW64)

## Architecture Overview
The app uses a sidebar navigation layout. All CRUD screens are single-page with Stimulus controllers that call JSON API endpoints. There are NO Turbo Frames or Turbo Streams used for data — all data operations go through fetch() calls to /api/* endpoints.

### Layout Structure
- Collapsible left sidebar (w-56 expanded, w-16 collapsed) with gradient purple background
- Sidebar groups: Accounts (Account Types, Transfers), Deposits (Recurring Deposits, Frequencies), Payments (Categories, Spending Types), Admin (DBU, Diagnostics, Documentation, Quotes, Frequency Masters — admin only, always at bottom). Sub-menus sorted alphabetically within each group, except Frequency-related items which are always pinned to the bottom of their group.
- Collapse/expand toggle button at bottom of sidebar, next to profile name (circular, bg-white/10)
- Bottom sidebar section: user profile button (name + avatar) — click to expand/collapse dropdown with Theme toggle, Settings link, Soft Close Month, Open Soft Close, Sign Out link. "Soft Close Month" snapshots account and dashboard data then advances to the next month. "Open Soft Close" reopens the previous month (blocked if current month has transactions). Both actions trigger confirmation modals before executing.
- Top header bar showing "Hello {first name}" with the current open month (from open_month_masters) displayed underneath in secondary text, motivational quote (wraps without overlapping right-side elements), current date, and profile dropdown (upper-right corner with avatar, contains Toggle Theme, Settings, Sign Out — always visible, sticky z-30)
- Stacked sticky headers: On the Payments page, the page toolbar (h1 + Add Payment button) is sticky top-14 z-20 with shadow-sm, stacking below the Hello bar (sticky top-0 z-30) so both remain visible while scrolling. IMPORTANT: The Payments page container must NOT have overflow-x-hidden, as this breaks position:sticky in Safari/iPad. The table has its own overflow-x-auto wrapper.
- Responsive filter grid: Payments filters use CSS Grid (.payments-filter-grid) with explicit breakpoints. Tablet (768–1279px): 4-column, 2-row layout — Row 1: Start Date, End Date, Account, Reset; Row 2: Category, Spending Type, Search Input, Search Button. Desktop (1280px+): single row. Date inputs min-width 160px, Account/Category min-width 170px, Spending Type max-width 220px on tablet. All dropdowns use text-overflow: ellipsis. Reset and Search buttons identical size, vertically aligned in right column. Gap: 14px.
- Main content area shifts with sidebar via margin
- Sidebar state + group collapse state persisted in localStorage
- Dark/light theme toggle persisted in localStorage
- Global footer on all screens: Contact · Help · Terms · Privacy · © BudgetHQ {year} — centered, single-line, gray text, sticks to bottom via flex layout

### Pattern: Every CRUD Screen Follows This Architecture
1. **HTML page controller** (e.g., AccountsController#index) — renders the HTML shell with a Stimulus data-controller div
2. **API controller** (e.g., Api::AccountsController) — JSON CRUD endpoints (index, create, update, destroy)
3. **Stimulus controller** (e.g., accounts_controller.js) — fetches data on connect(), renders table rows as innerHTML, manages add/edit/delete state machine (idle → adding → editing)
4. **Inline editing** — edit row replaces display row, Enter saves, Escape cancels. Payments uses a modal for both Add and Edit (all other screens use inline add/edit rows). As of v1.1.9, Payments Edit was converted from inline row editing to a modal-based workflow using the same modal as Add. As of v1.2.0, DBU Record Browser also uses modal-based CRUD — the record panel is read-only display with Edit/Delete buttons opening modals, and Add opens a modal.
5. **Soft delete** — all models use deleted_at timestamp, default_scope excludes deleted records

## Admin Role
- **budgethq_agent** boolean on users table (default false). Only DJ and Elijah have this flag.
- Admin users see an "Admin" group in the sidebar containing: DBU, Users, Documentation, and Frequency Masters.
- Admin users also see Generate Data buttons on all CRUD screens.
- Non-admins see the normal user experience without admin tools.
- Admin user management screen (/admin/users, titled "Admin Users") lets admins search users and toggle admin status via API.

## Database Tables

### Core User Data
- **users** — Devise fields + first_name, last_name, avatar_url, phone_number, secondary_email, budgethq_agent, two_factor_enabled, subscription_active, subscription_start_date, subscription_expiration_date
- **identities** — OmniAuth provider linkage (provider, uid, tokens)
- **user_emails** — Alternate email addresses with verification (user_id, email, verification_code, verified_at)
- **user_phones** — Alternate phone numbers with SMS verification (user_id, phone_number, verification_code, verified_at)
- **phone_verifications** — SMS verification codes

### Spending Side
- **spending_types** — user-scoped categories of spending (Need, Want, Savings — seeded as system defaults)
- **spending_categories** — user-scoped, belongs_to spending_type (Groceries, Dining, Mortgage — seeded)
- **account_types** — user-scoped (Checking, Savings, Venmo — seeded as system defaults). Has use_flag boolean toggle — when ON, appears in account type dropdowns; when OFF, hidden from dropdowns.
- **accounts** — user-scoped, belongs_to account_type (balance, beginning_balance, include_in_budget flag)
- **payments** — user-scoped, belongs_to account + spending_category, optional spending_type_override. Payment create/update/destroy adjusts account balance in a transaction.

### Income Side
- **income_frequency_masters** — global lookup table with 59 frequency patterns across 3 types: standard (11), exact_day (29: 1st-28th + Last Day), ordinal_weekday (20: 1st-4th Mon-Fri). Pre-seeded. Agent-editable via Frequency Masters screen.
- **income_user_frequencies** — user-scoped join to frequency_masters with use_flag toggle
- **income_recurrings** — user-scoped recurring income sources (name, amount, frequency, next_date, use_flag). Has advance_next_date! to calculate next occurrence.
- **income_entries** — user-scoped income transactions. Auto-generated from due recurrings via IncomeEntry.generate_due_entries_for(user). Has received_flag toggle. When received_flag is toggled ON, account balance is adjusted (same transactional pattern as payments). Income entries with received_flag=true for budget accounts are summed into Dashboard Card 4 as "Income".

### Admin / System Tables
- **bug_reports** — screen_name, description, processed_date. Displayed on Documentation &gt; Release Notes, paginated by date (5 days per page).
- **legal_pages** — slug (unique), title, content (HTML), published_at. Stores Privacy Policy, Terms of Service, etc. Accessible at /pages/:slug. Seeded via db/seeds/legal_pages.rb. Content uses card-based layout with data-section attributes for dynamic TOC generation.
- **transfer_masters** — user_id (FK), transfer_date (date), from_account_id (FK → accounts), to_account_id (FK → accounts), amount (decimal 12,2), memo (varchar, optional). Account-to-account transfers. Adjusts account balances on create/update/delete. Transfers do NOT count as payments or income, do NOT appear in Recent Activity or Category Spending.
- **net_worth_snapshots** — user_id (FK), snapshot_date (date, unique per user), amount (decimal 12,2). Stores monthly net worth history for the dashboard chart. Shows up to 6 months. Admin can populate test data via POST /api/net_worth_snapshots/populate.
- **open_month_masters** — user_id (FK, unique), current_year (int), current_month (int 1-12), is_closed (boolean, default false), locked_at (datetime, nullable), locked_by_user_id (FK nullable), has_data (boolean, default false), first_data_at (datetime, nullable), first_data_source (varchar, nullable — e.g. "Payment", "IncomeEntry", "TransferMaster"), reopen_count (int, default 0), last_reopened_at (datetime, nullable), last_reopened_by_user_id (FK nullable → users). Tracks the user's currently selected operating month. One row per user, updated when navigating months on the dashboard. has_data is set to true when any payment, deposit, or transfer is created for the current open month (first_data_at and first_data_source capture the first such event). reopen_count tracks how many times the month was reopened; last_reopened_at and last_reopened_by_user_id record the most recent reopen.
- **account_month_snapshots** — id, user_id (FK), account_id (FK → accounts), year (int), month (int 1-12), beginning_balance (decimal 12,2), ending_balance (decimal 12,2), is_stale (boolean, default false), created_at, updated_at. Per-account balance snapshots generated when a month is closed (via POST /api/open_month_master/close). beginning_balance captures the account balance at the start of the month; ending_balance captures it at close. Marked is_stale=true if the month is later reopened. Unique constraint on [user_id, account_id, year, month].
- **dashboard_month_snapshots** — id, user_id (FK), year (int), month (int 1-12), total_spending (decimal 12,2), total_income (decimal 12,2), total_transfers (decimal 12,2), net_worth (decimal 12,2), is_stale (boolean, default false), created_at, updated_at. Aggregated dashboard card value snapshots generated when a month is closed (via POST /api/open_month_master/close). Captures the dashboard summary values at month-close time. Marked is_stale=true if the month is later reopened. Unique constraint on [user_id, year, month].
- **quotes** — quote_text (text, NOT NULL), quote_author (varchar 120, nullable), is_active (boolean, default true). System-wide inspirational quotes displayed on sign-in page and in the header bar. Not user-scoped. Admin-only CRUD via /quotes screen. Random active quote shown on sign-in; daily quote cached in session for header bar display.

### Key Relationships
- User has_many: spending_types, spending_categories, account_types, accounts, payments, income_user_frequencies, income_recurrings, income_entries, transfer_masters, account_month_snapshots, dashboard_month_snapshots; has_one: open_month_master
- SpendingType has_many spending_categories; SpendingCategory has_many payments
- AccountType has_many accounts; Account has_many payments, transfers_from, transfers_to, account_month_snapshots
- IncomeRecurring has_many income_entries; both link to frequency_master and optional account
- All user-owned models use soft delete (deleted_at) with default_scope

## Routes Structure
```
/ ...................... Landing page (redirects to dashboard if signed in)
/dashboard ............. Dashboard with 6 cards (budget, accounts, net worth, income/spending, recent activity, buckets)
/pricing ............... Subscription pricing page (3 tiers: Free, Paid, Advanced) with monthly/annual toggle
/accounts .............. Accounts CRUD screen
/transfer_masters ...... Account Transfers CRUD screen (modal-based add/edit/delete)
/account_types ......... Account Types CRUD screen
/spending_types ........ Spending Types CRUD screen
/spending_categories ... Categories CRUD screen
/payments .............. Payments CRUD screen (with advanced filtering & combination search)
/income_entries ........ Deposits CRUD screen (with Generate Data button)
/income_recurrings ..... Recurring Deposits CRUD screen
/income_user_frequencies Frequencies toggle screen
/income_frequency_masters Frequency Masters CRUD (admin-only)
/quotes ................. Quotes CRUD screen (admin-only)
/admin/users ............. Admin user management (admin-only)
/dbu .................. Database Utility admin tool (admin-only)
/documentation ......... Documentation index (admin-only sidebar link)
/documentation/database-schema
/documentation/database-visualization
/documentation/release-notes
/documentation/claude-prompt
/documentation/architecture-overview
/documentation/deployment-runbook
/documentation/test-coverage
/documentation/environment-variables
/pages/:slug ........... Legal pages (privacy, terms) — no auth required

API endpoints (all under /api/):
  /api/spending_types ......... CRUD
  /api/spending_categories .... CRUD
  /api/account_types .......... CRUD
  /api/accounts ............... CRUD
  /api/transfer_masters ....... CRUD (with transactional balance updates on both from/to accounts)
  /api/payments ............... CRUD (with transactional balance updates)
  /api/income_frequency_masters  CRUD + GET :id/can_delete (admin-only, delete blocked if in use by any user)
  /api/income_user_frequencies  index + update (use_flag toggle per frequency)
  /api/income_recurrings ...... CRUD
  /api/income_entries ......... CRUD + POST /generate (with transactional balance updates on received_flag)
  /api/admin/users ........... index + update (admin toggle, admin-only)
  /api/dbu/schema ............ DBU schema inspector — queries information_schema for all tables/columns/keys (admin-only)
  /api/dbu/tables ............ DBU table catalog for record browser (admin-only)
  /api/dbu/users ............. DBU user list (admin-only)
  /api/dbu/records ........... DBU record list/show/create/update/delete (admin-only)
  /api/dashboard/card_data ... GET with month/year params — returns spending, income/spending, and recent activity data for Cards 1, 4, 5
  /api/bug_reports ........... index (paginated by date) + create
  /api/net_worth_snapshots ... index (recent 6) + POST /populate (admin-only, generates test history)
  /api/open_month_master .... GET show + PUT update (singular resource, one per user)
  /api/open_month_master/close  POST — Closes the current open month and advances to the next month. Generates account_month_snapshots (per-account beginning/ending balances) and dashboard_month_snapshots (aggregated spending, income, transfers, net worth) for the closing month. Sets is_closed=true on the closing month before advancing.
  /api/open_month_master/reopen POST — Reopens the previous month by moving the open month back. Blocked with 422 if the current month has_data=true (must have no payments/deposits/transfers in the current month to reopen prior). Increments reopen_count, sets last_reopened_at and last_reopened_by_user_id. Marks existing snapshots for the reopened month as is_stale=true.
  /api/quotes .............. CRUD (admin-only, system-wide quotes for sign-in display, cache invalidation on changes)
```

## Stimulus Controllers
Each CRUD screen has a matching Stimulus controller in app/javascript/controllers/:
- **sidebar_controller.js** — collapse/expand sidebar, group toggles, tooltips, flyout menus, mobile hamburger
- **flash_controller.js** — auto-dismiss flash messages after 5s
- **dropdown_controller.js** — simple toggle + outside-click close
- **theme_controller.js** — dark/light mode toggle
- **otp_controller.js** — 6-digit OTP input with auto-submit
- **spending_types_controller.js** — CRUD with icon/color picker, generate dummy data
- **spending_categories_controller.js** — CRUD with type select, debt toggle
- **account_types_controller.js** — CRUD with icon/color picker, generate dummy data
- **accounts_controller.js** — CRUD with type select, budget toggle, generate dummy data. Add Account validates effective_date against the current open month: client-side date picker is constrained to the open month's date range, server-side returns 409 Conflict if effective_date falls outside the open month.
- **payments_controller.js** — CRUD with date/account/category/type filters, search, combination sum search, CSV export of filtered/sorted data, print-friendly report with BudgetHQ header (mirrors filters/sorting), generate dummy data. After adding a payment, the list refreshes in the current sort order and scrolls to the top. After add/edit/delete, account balances are re-fetched from the server to stay in sync. Total display uses text-lg font-semibold for visual emphasis. On Add/Edit save, validates payment date against the current open month (fetched from /api/open_month_master). If date falls outside open month, shows a warning modal with Cancel/Proceed. Proceed advances the open month to match the payment date's month/year and then saves. As of v1.1.9, Edit uses a modal (same as Add modal) instead of inline row editing. The Edit modal enforces month control — payments can only be edited if their date falls within the current open month. The server-side update action returns 409 Conflict if the payment's date is outside the current open month.
- **upload_controller.js** — Reusable CSV upload/import controller. Workflow: download template → upload CSV → validation grid with inline editing → batch import via existing API create endpoints. Used on all 9 data screens (admin only). Config passed via HTML data attributes (fields, lookups, API URL). Template download supports 3 formats: CSV, Excel (XML-based XLS with styling), and Apple Numbers (CSV with UTF-8 BOM). Format selection persisted in localStorage. Google Sheets (TSV + opens sheets.google.com) also coded but not yet exposed in UI.
- **pricing_controller.js** — Billing toggle (monthly/annual) on the pricing page. Dynamically updates price displays and savings badges for Paid ($3.99/mo or $25/year) and Advanced ($5.99/mo or $35/year) tiers. Free tier always $0.
- **income_frequency_masters_controller.js** — CRUD with inline editing, active toggle, sort_order editing (admin-only). Delete action checks server-side in-use status (via /can_delete endpoint) — blocks with "Can't Delete" modal if frequency is referenced by any user, otherwise shows standard delete-confirm modal. Active toggle is the sole activation control (no Deactivate/Reactivate buttons). UI text renamed from "Income Entries" to "Deposits" throughout.
- **income_user_frequencies_controller.js** — use_flag toggle list with "View All" filter toggle (OFF = show only enabled frequencies, ON = show all master frequencies; purely a view filter, no bulk API call)
- **income_recurrings_controller.js** — CRUD with frequency/account selects, generate dummy data
- **income_entries_controller.js** — CRUD with received toggle (opens edit on amount), auto-advance cursor between fields on change, Generate Data button
- **admin_users_controller.js** — Admin user management with search, admin toggle (admin-only)
- **quotes_controller.js** — Admin CRUD for system quotes (add, edit, delete, active toggle). Quotes are displayed on sign-in page (random active) and in header bar (daily quote cached in session). Replaces the former hardcoded 200-quote rotation.
- **bug_reports_controller.js** — Paginated release notes grouped by date with "Show More" pagination (5 days per page)
- **settings_emails_controller.js** — Alternate emails management: fetch, render with verified/unverified badges, inline 6-digit code verify, resend, remove with confirm
- **settings_phones_controller.js** — Alternate phones management: fetch, render with verified/unverified badges, inline 6-digit SMS code verify, resend, remove with confirm (parallel implementation to emails)
- **dashboard_controller.js** — Month navigation for dashboard Cards 1, 4, 5: shared month/year state, prev/next arrows, fetches data from /api/dashboard/card_data, re-renders card content dynamically, right arrow disabled at current month. Card 2 pie chart accounts are sorted by descending balance. Card 2 has expand/collapse control: expand icon in lower-right corner (both front + back sides), expanded state fills full dashboard grid area hiding other cards, collapses via icon click or ESC key, UI-only state (resets on page reload).
- **legal_toc_controller.js** — Interactive table of contents for legal pages (Privacy Policy, Terms of Service). Builds TOC dynamically from [data-section] attributes in content, uses IntersectionObserver scroll spy to highlight active section, smooth-scrolls to section on click. Two-column layout: sticky left sidebar TOC + right content area with card-based sections and visualizations (colored info cards, security diagram, rights grid, cookies table).
- **dbu_controller.js** — Database Utility with two tabs: (1) Schema Inspector — queries information_schema to list ALL tables and ALL columns with data type, nullability, default, PK/FK/UQ badges, expand/collapse per table, filter by table/column name, Expand All/Collapse All, Refresh DBU, Export CSV/JSON, Last Refreshed timestamp and database name; (2) Record Browser (default landing view) — dropdown lists ALL tables from information_schema (identical to Schema Inspector), Refresh button to reload metadata, table count + schema info displayed, browse/edit records, search, user filter, record navigation (Prev/Next), dirty state protection, save/delete, "+ Add Record" button to create new records for the selected table. Both views share the same information_schema source ensuring consistent table counts. As of v1.2.0, Record Browser uses modal-based CRUD: the record detail panel is read-only display with Edit and Delete buttons that open modals, and the Add button also opens a modal. The DBU sub-header is sticky below the global header. Schema Inspector and Record Browser both query information_schema; the /api/dbu/tables endpoint uses the same information_schema source as the schema endpoint. Admin-only.
- **month_actions_controller.js** — Stimulus controller for User Menu month actions. Provides "Soft Close Month" (generates account_month_snapshots + dashboard_month_snapshots, then advances the open month to the next month) and "Open Soft Close" (reopens the previous month if no transactions exist in the current month). Both actions use confirmation modals defined in the application layout before executing.

## Seeding & Initialization
- db/seeds.rb creates test user (test@example.com / password123) and 40+ IncomeFrequencyMaster records
- On first visit, each screen auto-seeds defaults per user (spending types, categories, account types, frequencies)
- Must visit /spending_types before /spending_categories for new users (seeding dependency)

## Key Patterns & Conventions
1. **Soft delete everywhere** — model.soft_delete!, default_scope { where(deleted_at: nil) }
2. **User-scoped queries** — always current_user.model.find/build/create
3. **Transactional balance** — payments and received income entries adjust account.balance atomically
4. **State machine UI** — Stimulus controllers track state: idle/adding/editing
5. **Generate Data buttons** — most screens have a button to create dummy data for testing
6. **Sort order** — auto-assigned as max(sort_order)+1 on create
7. **Case-insensitive uniqueness** — name fields use lower() index with deleted_at IS NULL filter
8. **API error format** — { errors: ["message"] } with 422 status
9. **Admin gating** — Admin sidebar group (DBU, Users, Documentation, Frequency Masters, Quotes), Generate Data buttons, and admin API endpoints are only visible/accessible to users with budgethq_agent=true
10. **Motivational quotes** — Random active quote from the `quotes` table shown on sign-in page; daily quote cached in session and displayed in header bar. Admin CRUD screen at /quotes for managing quotes. Seeded with 200 financial quotes with authors. Cache is version-tracked: when an admin creates/updates/deletes a quote, the cache version is bumped and all sessions refresh the quote on next page load.
11. **Auto-cancel editing** — Clicking Add/Edit/Delete while another row is being edited auto-cancels the previous edit (no need for explicit cancel)
12. **Auto-save toggles** — All toggle switches (budget, use_flag, active, admin) save immediately via API without requiring a Save button
13. **Auto-advance cursor** — Deposits fields auto-advance focus to the next field in sequence (date → account → source → description → amount → frequency) on change. Payments add-row also auto-advances: Date → Account → Category → (auto-populate Spending Type) → Description
14. **Dashboard cards with month navigation** — Cards 1 (Spending Overview), 4 (Income &amp; Spending), and 5 (Recent Activity) all display month/year with left/right arrows for month navigation. All three cards share the same month state via a `dashboard` Stimulus controller that fetches data from `GET /api/dashboard/card_data?month=N&amp;year=YYYY`. Right arrow is disabled when at the current real-world month. Card 1 shows "$X spent this month" donut (no "Month To Date" text). Card 2 (Accounts) shows "Total: {sum}" in the header with a flip-card feature: front shows account list with a pie icon (lower-left footer) and "Manage Accounts" link (lower-right), clicking the pie icon flips the card to show a pie chart of account balances on the back side with a "Flip back" link. The pie chart legend shows each account with its name, balance, and percentage (e.g. "Checking — $122.92 — 6%"). Card 3 (Net Worth) chart runs chronologically LEFT → RIGHT (oldest on left, newest on right) with real data-driven SVG line chart from net_worth_snapshots table. Admins see "Populate Test Data" dropdown on Card 3.
15. **Delete guards** — Accounts, spending categories, and spending types cannot be deleted if they have dependent records (payments or child categories). The API returns a 422 error with a descriptive message.
16. **Resilient payment loading** — The payments index API preloads associations using unscoped queries, so payments with soft-deleted accounts/categories/types still render (showing "[Deleted]" labels) instead of crashing the entire endpoint.
17. **Dashboard Recent Activity filter** — Card 5 (Recent Activity) excludes payments with future dates (payment_date > today) so scheduled payments don't appear prematurely.
18. **Deposits rename** — "Income Entries" renamed to "Deposits" and "Recurring Income" to "Recurring Deposits" across sidebar, page headers, buttons, info text, and documentation.
19. **Deposits deleted account display** — Deposits API preloads accounts with unscoped queries so deleted account names still display (read-only) instead of blank.
20. **Deposits column sorting** — Date, Account, Source, Description, and Amount columns are click-to-sort with ASC/DESC toggle and arrow indicators.
21. **Settings page parity** — Email and Phone settings sections have identical structure: editable primary field (email_field / telephone_field), border-separated alternate section with Stimulus-managed add/verify/remove, and verified/unverified badges. Primary phone changes do not require current password. Two-Factor toggle is disabled with red warning message when no verified phone exists (primary or alternate).
22. **Sticky page subheaders (REQUIRED for all screens)** — Every CRUD/index screen must have a sticky page header containing the h1 title, subtitle, and action buttons (Add, Generate Data, Export, etc.). The header stays pinned below the global "Hello" bar when scrolling so buttons are always accessible. Pattern: `&lt;div class="sticky top-14 z-20 bg-gray-50 dark:bg-gray-900 -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8 py-4 mb-2 border-b border-gray-200 dark:border-gray-700 shadow-sm"&gt;` wrapping a `flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3` inner div. IMPORTANT: Parent containers must NOT have overflow-x-hidden as it breaks position:sticky in Safari.
23. **Open month has_data tracking** — Creating a payment, deposit (income entry), or transfer automatically sets has_data=true on the open_month_master for the current month (along with first_data_at and first_data_source if this is the first transaction). This flag is used to guard against reopening a prior month when the current month already has data.
24. **Month close with snapshots** — POST /api/open_month_master/close advances the open month to the next month/year and generates two sets of snapshots for the closing month: (a) account_month_snapshots with each account's beginning_balance and ending_balance, and (b) a dashboard_month_snapshot with aggregated totals (total_spending, total_income, total_transfers, net_worth). These snapshots preserve historical month-end state.
25. **Month reopen with stale marking** — POST /api/open_month_master/reopen moves the open month back to the previous month. It is blocked (422) if the current month has_data=true to prevent data conflicts. On successful reopen, all existing snapshots for the reopened month are marked is_stale=true (since data may now change), and the open_month_master's reopen_count is incremented.
26. **User Menu month actions (v1.2.0)** — The sidebar user menu exposes "Soft Close Month" and "Open Soft Close" actions via the month_actions_controller.js Stimulus controller. Soft Close calls POST /api/open_month_master/close; Open Soft Close calls POST /api/open_month_master/reopen. Both actions display confirmation modals (defined in the application layout) before executing. This gives users a direct way to manage month transitions from the sidebar without navigating to a separate screen.
27. **Effective date open-month validation (v1.2.0)** — Accounts Add enforces that the effective_date falls within the current open month. The client-side date picker is constrained to the open month's date range. The server returns 409 Conflict if the effective_date is outside the open month, matching the same pattern used by Payments.
28. **Frequency Masters delete with in-use guard (v1.2.1)** — FrequencyMasters support hard delete ONLY when the frequency is not in use by any user. The /can_delete endpoint checks income_user_frequencies, income_recurrings, and income_entries. If in use, a "Can't Delete Frequency" modal is shown. If not in use, the standard delete-confirm modal proceeds. The server enforces the same check at delete time for race condition safety. Active/Inactive status is controlled solely by the toggle switch (no Deactivate/Reactivate action buttons).
29. **DBU modal-based CRUD (v1.2.0)** — The DBU Record Browser now uses modal dialogs for all CRUD operations. The record detail panel is read-only with Edit and Delete buttons that open modals. The Add button also opens a modal. The DBU sub-header is sticky below the global header. Schema Inspector and Record Browser both query information_schema for table metadata; the /api/dbu/tables endpoint uses the same information_schema source as /api/dbu/schema.

## Development Notes
- Windows filesystem is case-insensitive but Rails can fail template lookups if path case doesn't match. Always start server from C:/Projects/ExpenseTracker (correct case).
- Tailwind is loaded via CDN with JIT — classes must exist in HTML for generation. Dynamic class toggling via JS uses classList.add/remove (not string interpolation).
- With Turbo loaded, forms submit via fetch(). Use Promise.all([page.waitForURL(...), page.click(...)]) for Turbo navigation waits in tests.
- Flash messages are positioned fixed top-right and auto-dismiss after 5s.
- **Version system** — APP_VERSION in config/initializers/version.rb. Displayed in footer. "What's New" popup shows changelog on first visit after deploy (session-tracked). APP_VERSIONS array holds last 5 versions with change lists.
- **QA Mode banner** — QA_MODE flag in version.rb. When true, a red banner "NEW RELEASE QA MODE — vX.X.X" appears at the top of every page. Set to true before deploying for production QA testing, set to false after moving specs to Ready for QA.
- **.gdoc file reading** — Google Drive for Desktop .gdoc files are cloud shortcuts that cannot be read via standard file I/O. Use `read_gdoc.py` (Python script in project root) which looks up the doc ID from DriveFS's metadata_sqlite_db and fetches content via Google Docs API with OAuth. Requires one-time setup: gdoc_credentials.json from Google Cloud Console. .docx files are read via Node.js JSZip (extract word/document.xml, strip XML tags).

## Task Intake: "Lets Work" Workflow

All work items are managed via Google Drive at **G:\My Drive\ExpenseTracker** using a Kanban-style folder flow:

### Folder Structure
- **Open Items** — bugs (text files) and new features (subfolders) waiting to be worked
- **In Process** — the single item currently being worked on
- **Ready for QA** — completed items awaiting user verification

### When I say "Lets Work"
1. **Launch WorkLauncher** — Run: `powershell -Command "Start-ScheduledTask -TaskName 'WorkLauncher'"`
2. Navigate to **G:\My Drive\ExpenseTracker\Open Items**
3. Pick up to **5 items** (text files or feature folders) to work on
4. For each item:
   a. **Move** it from Open Items → **In Process**
   b. **Plan** the implementation
   c. **Build** the changes
   d. **Test locally** with Playwright against both **Safari** and **Chrome** browsers
   e. Repeat for the next item (up to 5 items before deploying)
5. After processing up to 5 items, **deploy** to production:
   a. Set `QA_MODE = true` in `config/initializers/version.rb`
   b. Bump `APP_VERSION` and add changelog entry to `APP_ALL_VERSIONS`
   c. Update all documentation pages (database_schema, claude_prompt, etc.)
   d. Commit to GitHub, trigger Render deploy
   e. Run `node export_docs.js` to export ALL documentation pages to Google Drive and `C:\Projects\ExpenseTracker\documentation`
6. **Test production** at https://djburrup.com/expensetracker with both accounts:
   - elijahburrup323@gmail.com / Eli624462!
   - djburrup@gmail.com / luckydjb
7. Once all production tests pass:
   a. Set `QA_MODE = false` in version.rb, commit and push
   b. **Move** all processed items from In Process → **Ready for QA**
8. Go back to **Open Items** and grab the next batch — repeat

### Bug text files
- Process items that have **no status**, or are marked **NOT FIXED**, **FAILED**, or similar
- **Skip** items marked **PASSED**, **FIXED**, or similar — they are already done

### General rules
- Work items one at a time (one item in "In Process" at a time)
- Deploy automatically when changes are ready and tested
- Commit to GitHub and trigger Render deploys as needed

## Behavior Rules
- **Never ask for acknowledgement or confirmation to continue.** Just do the work. Do not pause to say "shall I proceed?" or "ready to continue?" — execute each step and move to the next automatically.
- Do not ask "does this look good?" mid-task. Complete the full workflow, then present results.

## Pre-Commit Checklist
Before each git commit, update these items:
1. app/views/documentation/database_schema.html.erb — reflect any schema changes
2. app/views/documentation/claude_prompt.html.erb — reflect any architectural/feature changes
3. config/initializers/version.rb — bump APP_VERSION, add changelog to APP_ALL_VERSIONS

## Post-Deploy Checklist
After each deploy, run:
1. `node export_docs.js` — exports ALL documentation pages as .docx to Google Drive AND to C:\Projects\ExpenseTracker\documentation

## How We Work Together (Claude Code + Developer)

### Session Workflow
- Developer says "Lets Work" → Claude picks up to 5 items from Open Items, processes them end-to-end
- Claude moves files between Google Drive Kanban folders automatically (Open Items → In Process → Ready for QA)
- Claude never pauses for confirmation — executes the full plan/build/test/deploy/QA cycle autonomously
- When Open Items is empty after a batch, Claude sends notification email via the app's diagnose endpoint

### Parallel Work Pattern
- Documentation updates (database_schema + claude_prompt) run as background agents in parallel during deploy prep
- Multiple Playwright test suites run sequentially per browser (Chrome first, then Safari)
- Independent code exploration tasks are launched as parallel agents

### Email Notification (Open Items Empty)
- Sent via authenticated Playwright session hitting: `GET /api/diagnose_send?email=elijahdburrup@gmail.com&notify=...&notify_body=...`
- Uses the `TestMailer.kanban_notify` mailer method
- Route is `diagnose_send` (NOT `diagnose/test_send`) — the route file maps `get "diagnose_send"` to `diagnose#test_send`
- Requires authentication (behind Api::BaseController) — cannot use unauthenticated curl

### Production Test Accounts
- Primary: elijahburrup323@gmail.com / Eli624462!
- Secondary: djburrup@gmail.com / luckydjb

## Key Learnings & Gotchas

### Rails Route Helper Naming
- **CRITICAL**: For `resource :foo` (singular) with `post :bar` inside, Rails generates `bar_api_foo_path` NOT `api_foo_bar_path`
- Example: `resource :open_month_master` with `post :close` → correct helper is `close_api_open_month_master_path`
- Always verify with `bundle exec rails routes | grep <name>` before using route helpers in views
- Getting this wrong causes 500 errors on production (NameError: undefined method)

### Playwright Test Patterns
1. **What's New overlay**: The `#whatsNewOverlay` is a full-screen fixed overlay (z-50) that blocks all clicks. Must be removed via `page.evaluate(() => document.getElementById('whatsNewOverlay')?.remove())` BEFORE any UI interaction. The Stimulus-based `[data-dashboard-target='whatsNewModal']` is a different element — dismiss both.
2. **QA MODE banner**: The red sticky banner (z-[9999]) can intercept pointer events on elements positioned under it. Use `{ force: true }` on clicks when the banner might overlap.
3. **Scoping locators**: `page.locator("text=Soft Close Month")` may match sidebar elements (hidden). Scope to the correct container: `page.locator(".sticky [data-controller='dropdown']").first().locator("text=Soft Close Month")` to target the header dropdown specifically.
4. **Login helper**: Use `Promise.all([page.waitForURL(...), page.click(...)])` for Turbo navigation. If login times out, the password is likely wrong (check screenshot — password field will be empty or page won't redirect).
5. **Test file naming**: Production tests go in `tests/` folder with pattern `prod-vXXX-batchN.spec.js`

### Deploy & QA Cycle
1. Set QA_MODE=true BEFORE deploying (include in the deploy commit)
2. Wait for Render deploy to complete (~2-3 minutes) before running production tests
3. Check for v-number in QA banner to confirm new code is live
4. Run all tests on Chrome first, then Safari — fix any failures before moving on
5. Set QA_MODE=false AFTER all tests pass, commit and push separately
6. Move items to Ready for QA only after QA_MODE=false is pushed

### Common Pitfalls
- **Don't use overflow-x-hidden on parent containers** — breaks position:sticky in Safari/iPad
- **Sticky sub-header stacking**: global header = `top:0 z-30`, page sub-header = `top:3.5rem z-20` (use inline style for fractional rem)
- **Modal z-index**: Use z-[9999] for modals to stack above everything including QA banner
- **Soft delete scope**: Always use `unscoped` when preloading associations that might reference deleted records
- **API error format**: 422 for validation errors `{ errors: [...] }`, 409 for conflict/month-control errors, 405 for disallowed methods

### File Reading from Google Drive
- `.docx` files: Copy to local first (`cp`), then extract via `node -e` with JSZip (read word/document.xml, strip XML tags)
- `.gdoc` files: Read via `node read_gdoc.js "<Doc Name>"` (uses Google Docs API; token in documentation/token.json)
- Google Drive path in MINGW64: `/g/My Drive/ExpenseTracker/` with numbered folders (`1. Open Items`, `2. In Process`, `3. Ready for QA`)</div>
</div>
