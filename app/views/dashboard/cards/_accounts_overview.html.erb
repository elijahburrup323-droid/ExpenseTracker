<%
  color_cycle = %w[blue green purple amber sky red]
  pie_colors_hex = %w[#3b82f6 #22c55e #a855f7 #f59e0b #0ea5e9 #ef4444]
  card2_total = @accounts.sum(:balance).to_f
  sorted_accounts = @accounts.sort_by { |a| -a.balance.to_f }
  pie_slices = []
  if card2_total > 0
    sorted_accounts.each_with_index do |account, i|
      pct = (account.balance.to_f / card2_total * 100)
      pie_slices << { name: account.name, balance: account.balance.to_f, pct: pct, color: pie_colors_hex[i % pie_colors_hex.length] }
    end
  end
%>
<div class="relative flex-1" data-role="flipper" style="transform-style: preserve-3d; transition: transform 0.6s;">
  <%# === FRONT SIDE === %>
  <div class="flex flex-col" data-role="front" style="backface-visibility: hidden;">
    <div data-role="front-content">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center">
          <h2 class="text-sm font-semibold text-gray-800 dark:text-gray-200"><%= card.title %></h2>
        </div>
        <span class="text-sm font-semibold text-gray-900 dark:text-white">Total: <%= number_to_currency(card2_total) %></span>
      </div>
      <ul class="space-y-3 flex-1">
        <% sorted_accounts.each_with_index do |account, i| %>
          <% c = color_cycle[i % color_cycle.length] %>
          <li class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
              <span class="w-7 h-7 rounded-lg bg-<%= c %>-100 dark:bg-<%= c %>-900/30 flex items-center justify-center">
                <svg class="w-4 h-4 text-<%= c %>-600 dark:text-<%= c %>-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                </svg>
              </span>
              <span class="text-sm text-gray-700 dark:text-gray-300"><%= account.name %></span>
            </div>
            <span class="text-sm font-semibold text-gray-900 dark:text-white"><%= number_to_currency(account.balance) %></span>
          </li>
        <% end %>
        <% if @accounts.empty? %>
          <li class="text-sm text-gray-400 dark:text-gray-500">No accounts yet.</li>
        <% end %>
      </ul>
    </div>
    <div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-700 flex items-center justify-between">
      <button type="button" class="inline-flex items-center justify-center text-brand-600 dark:text-brand-400 hover:text-brand-700 dark:hover:text-brand-300" style="min-width:44px; min-height:44px;" data-action="click->dashboard#flipCard" aria-label="View pie chart">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
          <path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/>
        </svg>
      </button>
      <div class="flex items-center space-x-3">
        <%= link_to accounts_path, class: "text-xs text-brand-600 dark:text-brand-400 hover:text-brand-700 dark:hover:text-brand-300 font-medium" do %>
          Manage Accounts &rsaquo;
        <% end %>
        <button type="button" data-action="click->dashboard#toggleCardExpand"
                data-role="expand-btn"
                class="inline-flex items-center justify-center text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 transition cursor-pointer" style="min-width:32px; min-height:32px;"
                aria-label="Expand Accounts Card">
          <svg class="w-4 h-4" data-icon="expand" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15"/>
          </svg>
          <svg class="w-4 h-4 hidden" data-icon="collapse" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
  <%# === BACK SIDE (Pie Chart) === %>
  <div class="absolute inset-0 flex flex-col" data-role="back" style="backface-visibility: hidden; transform: rotateY(180deg);">
    <div data-role="back-content">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-sm font-semibold text-gray-800 dark:text-gray-200"><%= card.title %></h2>
        <span class="text-sm font-semibold text-gray-900 dark:text-white">Total: <%= number_to_currency(card2_total) %></span>
      </div>
      <div class="flex-1 flex flex-col items-center justify-center overflow-hidden">
      <% if pie_slices.any? %>
        <svg viewBox="0 0 100 100" class="w-28 h-28 flex-shrink-0">
          <%
            cx, cy, r = 50, 50, 45
            angle = -90.0
            pie_slices.each do |slice|
              next if slice[:pct] <= 0
              sweep = (slice[:pct] / 100.0) * 360.0
              end_a = angle + sweep
              if sweep >= 359.99
          %>
            <circle cx="<%= cx %>" cy="<%= cy %>" r="<%= r %>" fill="<%= slice[:color] %>"/>
          <%
              else
                start_rad = angle * Math::PI / 180.0
                end_rad = end_a * Math::PI / 180.0
                x1 = (cx + r * Math.cos(start_rad)).round(2)
                y1 = (cy + r * Math.sin(start_rad)).round(2)
                x2 = (cx + r * Math.cos(end_rad)).round(2)
                y2 = (cy + r * Math.sin(end_rad)).round(2)
                large_arc = sweep > 180 ? 1 : 0
          %>
            <path d="M<%= cx %>,<%= cy %> L<%= x1 %>,<%= y1 %> A<%= r %>,<%= r %> 0 <%= large_arc %>,1 <%= x2 %>,<%= y2 %> Z" fill="<%= slice[:color] %>"/>
          <%
              end
              angle = end_a
            end
          %>
        </svg>
        <div class="mt-2 w-full space-y-1 overflow-y-auto" style="max-height: 5.5rem;">
          <% pie_slices.each do |slice| %>
            <div class="flex items-center text-xs px-1 min-w-0">
              <span class="w-2 h-2 rounded-full flex-shrink-0" style="background:<%= slice[:color] %>"></span>
              <span class="text-gray-700 dark:text-gray-300 truncate ml-1.5 min-w-0"><%= slice[:name] %> &mdash; <%= number_to_currency(slice[:balance]) %> &mdash; <%= slice[:pct].round(0) %>%</span>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-sm text-gray-400 dark:text-gray-500">No accounts to chart.</p>
      <% end %>
      </div>
    </div>
    <div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-700 flex items-center justify-between">
      <button type="button" class="text-xs text-brand-600 dark:text-brand-400 hover:text-brand-700 dark:hover:text-brand-300 font-medium" data-action="click->dashboard#flipCardBack">
        Flip back &rsaquo;
      </button>
      <button type="button" data-action="click->dashboard#toggleCardExpand"
              data-role="expand-btn"
              class="inline-flex items-center justify-center text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 transition cursor-pointer" style="min-width:32px; min-height:32px;"
              aria-label="Expand Accounts Card">
        <svg class="w-4 h-4" data-icon="expand" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15"/>
        </svg>
        <svg class="w-4 h-4 hidden" data-icon="collapse" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25"/>
        </svg>
      </button>
    </div>
  </div>
</div>
