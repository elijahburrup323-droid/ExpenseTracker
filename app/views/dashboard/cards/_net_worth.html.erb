<div class="flex items-center mb-1">
  <span class="drag-handle cursor-grab text-gray-300 hover:text-gray-500 dark:text-gray-600 dark:hover:text-gray-400 mr-2">
    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><circle cx="8" cy="4" r="1.5"/><circle cx="16" cy="4" r="1.5"/><circle cx="8" cy="12" r="1.5"/><circle cx="16" cy="12" r="1.5"/><circle cx="8" cy="20" r="1.5"/><circle cx="16" cy="20" r="1.5"/></svg>
  </span>
  <h2 class="text-sm font-semibold text-gray-800 dark:text-gray-200"><%= card.title %></h2>
</div>
<div data-role="card-content">
<div class="flex items-baseline space-x-2 mb-3">
  <span class="text-2xl font-bold text-gray-900 dark:text-white"><%= number_to_currency(@net_worth) %></span>
  <% if @net_worth_change >= 0 %>
    <span class="text-xs font-medium text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/30 px-1.5 py-0.5 rounded">
      +<%= number_to_currency(@net_worth_change) %> (<%= @net_worth_pct %>%)
    </span>
  <% else %>
    <span class="text-xs font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/30 px-1.5 py-0.5 rounded">
      <%= number_to_currency(@net_worth_change) %> (<%= @net_worth_pct %>%)
    </span>
  <% end %>
</div>

<%# Net Worth chart - driven by real snapshot data %>
<% snapshots = @net_worth_snapshots %>
<% if snapshots.size == 0 %>
  <%# No data - show empty state %>
  <div class="w-full h-20 flex-1 flex items-center justify-center">
    <p class="text-xs text-gray-400 dark:text-gray-500">No history yet</p>
  </div>
<% elsif snapshots.size == 1 %>
  <%# Single month - show single purple dot %>
  <div class="w-full h-20 flex-1">
    <svg viewBox="0 0 200 60" class="w-full h-full" preserveAspectRatio="xMidYMid meet">
      <circle cx="100" cy="30" r="5" fill="#a855f7"/>
    </svg>
  </div>
  <div class="flex justify-center text-[10px] text-gray-400 dark:text-gray-500 mt-1">
    <span><%= snapshots.first.snapshot_date.strftime("%b %Y") %></span>
  </div>
<% else %>
  <%# Multi-month line chart â€” chronological left to right %>
  <%
    amounts = snapshots.map { |s| s.amount.to_f }
    min_val = amounts.min
    max_val = amounts.max
    range = max_val - min_val
    range = 1 if range == 0
    padding = 5
    chart_h = 50
    chart_w = 190

    points = snapshots.each_with_index.map do |s, i|
      x = padding + (i.to_f / (snapshots.size - 1)) * chart_w
      y = padding + chart_h - ((s.amount.to_f - min_val) / range * chart_h)
      [x.round(1), y.round(1)]
    end

    polyline_str = points.map { |x, y| "#{x},#{y}" }.join(" ")
    area_path = "M#{points.first[0]},#{points.first[1]} " +
                points[1..].map { |x, y| "L#{x},#{y}" }.join(" ") +
                " L#{points.last[0]},#{padding + chart_h} L#{points.first[0]},#{padding + chart_h} Z"
  %>
  <div class="w-full h-20 flex-1">
    <svg viewBox="0 0 200 60" class="w-full h-full" preserveAspectRatio="none">
      <defs>
        <linearGradient id="netWorthGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#a855f7" stop-opacity="0.3"/>
          <stop offset="100%" stop-color="#a855f7" stop-opacity="0"/>
        </linearGradient>
      </defs>
      <path d="<%= area_path %>" fill="url(#netWorthGrad)"/>
      <polyline points="<%= polyline_str %>"
                fill="none" stroke="#a855f7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <% points.each do |x, y| %>
        <circle cx="<%= x %>" cy="<%= y %>" r="3" fill="#a855f7"/>
      <% end %>
    </svg>
  </div>
  <div class="flex justify-between text-[10px] text-gray-400 dark:text-gray-500 mt-1">
    <% snapshots.each do |s| %>
      <span><%= s.snapshot_date.strftime("%b %Y") %></span>
    <% end %>
  </div>
<% end %>

<p class="text-[10px] text-gray-400 dark:text-gray-500 mt-2 text-center">Your net worth chart will build automatically as more months are added.</p>
</div>

<% if current_user.budgethq_agent? %>
  <div class="mt-3 pt-3 border-t border-gray-100 dark:border-gray-700"
       data-controller="net-worth-populate"
       data-net-worth-populate-url-value="<%= populate_api_net_worth_snapshots_path %>">
    <div class="flex items-center space-x-2">
      <select data-net-worth-populate-target="months"
              class="text-xs border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300">
        <% (1..12).each do |m| %>
          <option value="<%= m %>"><%= m %> month<%= m > 1 ? 's' : '' %> back</option>
        <% end %>
      </select>
      <button type="button" data-action="click->net-worth-populate#populate"
              class="text-xs text-brand-600 dark:text-brand-400 hover:text-brand-700 dark:hover:text-brand-300 font-medium">
        Populate Test Data
      </button>
      <span data-net-worth-populate-target="status" class="text-xs text-gray-400 dark:text-gray-500"></span>
    </div>
  </div>
<% end %>
